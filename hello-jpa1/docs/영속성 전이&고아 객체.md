## 영속성 전이 (Cascade)

> 특정 엔티티를 영속 상태로 만들 때 연관된 엔티티도 함께 영속 상태로 만들고 싶을 때

- CASCADE 는 아래의 조건을 만족할 때만 쓰는 게 좋다!
1. 부모와 자식의 라이프사이클이 유사할 때 (등록, 삭제)
2. 단일 소유자(하나의 부모 엔티티에서만 자식 엔티티를 관리할 때)

- A -> B 관계가 CASCADE 로 되어있으면, A 엔티티를 persist 할 때 B 엔티티도 연쇄해서 함께 persist 한다!
  - cascade 는 mappedBy, 양방향 등과 전혀 관계가 없다. 복잡하게 다른 것들과 엮어서 생각할 필요없다
  - 꼭 연관관계의 주인이거나 부모일 때만 cascade 가 동작하는 것은 아니다
- 일대다에 모두 걸어야 한다기 보다는, 정말 하나의 부모가 자식들을 관리할 때 CASCADE 가 의미있다!
  - ex.) 게시판에서 각 글들의 첨부파일들을 관리할 때는 CASCADE 를 쓸 수 있다
- 소유자가 하나일 때는 CASCADE 를 써도 된다!
  - 그러나 자식을 여러 군데에서 관리할 때(자식이 여러 엔티티와 연관관계가 있을 때)는 CASCADE 를 쓰면 안된다!

## CASCADE 의 종류

- ALL: 모두 적용, 라이프사이클을 모두 맞춰야 할 때(저장, 삭제)
- PERSIST: 영속, 삭제하면 안될 때 즉 저장할 때만 라이프사이클을 맞춰야 할 때
- REMOVE, MERGE 등

---

## 고아 객체

> 고아 객체 제거 `orphanRemoval = true`: 부모 엔티티와 연관관계가 끊어진 자식 엔티티 를 자동으로 삭제

```java
Parent parent = em.find(Parent.class, id);
parent.getChildList().remove(0);  // 자식 엔티티를 컬렉션에서 제거
```
위와 같이 실행하면 고아객체가 되어 `DELETE FROM CHILD WHERE ID=?` 쿼리가 나간다

## 고아객체의 주의점

- 참조가 제거된 엔티티는 다른 곳에서 참조하지 않는 고아 객체로 보고 삭제하는 기능
- 참조하는 곳이 하나일 때 사용해야함!
- 특정 엔티티가 개인 소유할 때 사용
- 고아 객체 제거 기능을 활성화 하면, 부모를 제거할 때 자식도 함께 제거된다. 이것은 CascadeType.REMOVE처럼 동작한다

---

## 영속성 전이 + 고아 객체

`CascadeType.ALL + orphanRemoval=true`

- 스스로 생명주기를 관리하는 엔티티는 em.persist()로 영속화, em.remove()로 제거
  - 영속성 컨텍스트를 통해서 자신의 라이프사이클을 관리한다
- 두 옵션을 모두 활성화 하면 부모 엔티티를 통해서 자식의 생명 주기를 관리할 수 있음
  - 따라서 단일 소유인 경우에만 사용해야 한다!
- 도메인 주도 설계(DDD)의 Aggregate Root 개념을 구현할 때 유용